<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cytophage — семейный мир</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #020409;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #e5e5e5;
    }
    #canvas {
      display: block;
      width: 100vw;
      height: 100vh;
      background: radial-gradient(circle at center, #050814 0%, #010206 60%, #000000 100%);
      cursor: grab;
    }
    #canvas:active {
      cursor: grabbing;
    }
    .hud {
      position: fixed;
      left: 10px;
      top: 10px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 8px;
      font-size: 12px;
      pointer-events: none;
      max-width: 360px;
    }
    .hud .row {
      margin-top: 3px;
      white-space: nowrap;
    }
    .hud .row span.label {
      display: inline-block;
      min-width: 110px;
      color: #8b949e;
    }
    .hud .row span.value {
      display: inline-block;
      min-width: 90px;
    }
    .server-row {
      display: flex;
      align-items: center;
    }
    .server-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      background: #6e7681;
      box-shadow: 0 0 4px rgba(0,0,0,0.8);
    }
    .server-ok {
      background: #2ea043;
      box-shadow: 0 0 8px rgba(46,160,67,0.9);
    }
    .server-bad {
      background: #f85149;
      box-shadow: 0 0 8px rgba(248,81,73,0.9);
    }

    .hud-right {
      position: fixed;
      right: 10px;
      top: 10px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 8px;
      font-size: 12px;
      max-width: 260px;
      max-height: 520px; /* ~20 строк */
      overflow-y: auto;
      pointer-events: auto;
    }
    .hud-right-title {
      font-weight: 600;
      color: #79c0ff;
      margin-bottom: 4px;
      position: sticky;
      top: 0;
      background: rgba(0, 0, 0, 0.9);
      padding-bottom: 3px;
    }
    .leader-row {
      margin-top: 3px;
      border-bottom: 1px solid rgba(110,118,129,0.3);
      padding-bottom: 2px;
      padding-top: 2px;
    }
    .leader-row:last-child {
      border-bottom: none;
    }
    .leader-main {
      display: flex;
      justify-content: space-between;
    }
    .leader-name {
      font-weight: 500;
    }
    .leader-clan {
      color: #8b949e;
      margin-left: 4px;
    }
    .leader-info {
      font-size: 11px;
      color: #c9d1d9;
    }

    .controls {
      position: fixed;
      left: 10px;
      bottom: 10px;
      display: flex;
      gap: 8px;
      pointer-events: auto;
    }
    .btn {
      border: 1px solid #30363d;
      background: rgba(13,17,23,0.9);
      color: #e5e5e5;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
    }
    .btn:hover {
      background: rgba(22,27,34,0.95);
    }
    .btn-active {
      border-color: #2ea043;
      box-shadow: 0 0 6px rgba(46,160,67,0.6);
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <!-- Левая панель: статус и общая инфа -->
  <div class="hud">
    <div class="row server-row">
      <div id="serverDot" class="server-dot"></div>
      <div id="serverStatusText">Сервер: нет данных</div>
    </div>
    <div class="row" id="hudRow1"></div>
    <div class="row" id="hudRow2"></div>
    <div class="row" id="hudRow3"></div>
  </div>

  <!-- Правая панель: все колонии -->
  <div class="hud-right">
    <div class="hud-right-title">Колонии (кланы)</div>
    <div id="leadersList"></div>
  </div>

  <!-- Кнопки управления -->
  <div class="controls">
    <button id="toggleDetails" class="btn">Показать детали бактерий</button>
  </div>

  <script>
    // Сразу твой Render-URL:
    const SERVER_URL = "https://cytophage.onrender.com";

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const hudRow1 = document.getElementById("hudRow1");
    const hudRow2 = document.getElementById("hudRow2");
    const hudRow3 = document.getElementById("hudRow3");
    const serverDot = document.getElementById("serverDot");
    const serverStatusText = document.getElementById("serverStatusText");
    const leadersListEl = document.getElementById("leadersList");
    const toggleDetailsBtn = document.getElementById("toggleDetails");

    let width = window.innerWidth;
    let height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;

    window.addEventListener("resize", () => {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
    });

    let worldWidth = 8000;
    let worldHeight = 8000;

    let cameraX = worldWidth / 2;
    let cameraY = worldHeight / 2;
    let zoom = 0.1;

    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let cameraStartX = 0;
    let cameraStartY = 0;

    let showDetails = false;
    let lastStats = null;
    let world = { width: worldWidth, height: worldHeight };
    let bacteria = [];
    let food = [];
    let lastServerOk = false;

    toggleDetailsBtn.addEventListener("click", () => {
      showDetails = !showDetails;
      toggleDetailsBtn.textContent = showDetails
        ? "Скрыть детали бактерий"
        : "Показать детали бактерий";
      if (showDetails) {
        toggleDetailsBtn.classList.add("btn-active");
      } else {
        toggleDetailsBtn.classList.remove("btn-active");
      }
    });

    canvas.addEventListener("mousedown", (e) => {
      if (e.button !== 0) return;
      isDragging = true;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      cameraStartX = cameraX;
      cameraStartY = cameraY;
    });

    window.addEventListener("mouseup", () => {
      isDragging = false;
    });

    window.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      const dx = e.clientX - dragStartX;
      const dy = e.clientY - dragStartY;
      cameraX = cameraStartX - dx / zoom;
      cameraY = cameraStartY - dy / zoom;
    });

    canvas.addEventListener("wheel", (e) => {
      e.preventDefault();
      const zoomFactor = 1.1;
      const mouseX = e.clientX;
      const mouseY = e.clientY;

      const worldBeforeZoomX = (mouseX - width / 2) / zoom + cameraX;
      const worldBeforeZoomY = (mouseY - height / 2) / zoom + cameraY;

      if (e.deltaY < 0) {
        zoom *= zoomFactor;
      } else {
        zoom /= zoomFactor;
      }

      zoom = Math.max(0.02, Math.min(zoom, 2));

      const worldAfterZoomX = (mouseX - width / 2) / zoom + cameraX;
      const worldAfterZoomY = (mouseY - height / 2) / zoom + cameraY;

      cameraX += worldBeforeZoomX - worldAfterZoomX;
      cameraY += worldBeforeZoomY - worldAfterZoomY;
    }, { passive: false });

    function worldToScreen(x, y) {
      const sx = (x - cameraX) * zoom + width / 2;
      const sy = (y - cameraY) * zoom + height / 2;
      return { x: sx, y: sy };
    }

    function draw() {
      ctx.clearRect(0, 0, width, height);
      ctx.fillStyle = "#020409";
      ctx.fillRect(0, 0, width, height);

      // границы мира
      ctx.save();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(120, 255, 120, 0.6)";
      const topLeft = worldToScreen(0, 0);
      const bottomRight = worldToScreen(world.width, world.height);
      const w = bottomRight.x - topLeft.x;
      const h = bottomRight.y - topLeft.y;
      ctx.strokeRect(topLeft.x, topLeft.y, w, h);
      ctx.restore();

      // еда
      ctx.save();
      for (const f of food) {
        const p = worldToScreen(f.x, f.y);
        if (p.x < -20 || p.y < -20 || p.x > width + 20 || p.y > height + 20) continue;
        const r = 1.2 * zoom;
        ctx.beginPath();
        ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
        ctx.fillStyle = "hsl(120, 100%, 70%)";
        ctx.fill();
      }
      ctx.restore();


      // бактерии
      ctx.save();
      for (const b of bacteria) {
        const p = worldToScreen(b.x, b.y);
        if (p.x < -80 || p.y < -80 || p.x > width + 80 || p.y > height + 80) continue;

        const radius = Math.max(2, b.size * zoom);

        // тело (цвет клана)
        ctx.beginPath();
        ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
        ctx.fillStyle = b.familyColor || "#58a6ff";
        ctx.shadowBlur = radius * 1.5;
        ctx.shadowColor = ctx.fillStyle;
        ctx.fill();
        ctx.shadowBlur = 0;

        // кольцо лидера
        if (b.isLeader) {
          ctx.lineWidth = 2;
          ctx.strokeStyle = "rgba(255, 255, 255, 0.9)";
          ctx.beginPath();
          ctx.arc(p.x, p.y, radius + 3, 0, Math.PI * 2);
          ctx.stroke();
        }

        // полоска голода
        const barWidth = radius * 2.6;
        const barHeight = 3;
        const barX = p.x - barWidth / 2;
        const barY = p.y - radius - 8;

        ctx.fillStyle = "rgba(80, 80, 80, 0.6)";
        ctx.fillRect(barX, barY, barWidth, barHeight);

        const hungerRatio = Math.max(0, Math.min(1, b.hunger / b.maxHunger));
        ctx.fillStyle = hungerRatio > 0.3 ? "rgba(144, 238, 144, 0.9)" : "rgba(255, 99, 71, 0.95)";
        ctx.fillRect(barX, barY, barWidth * hungerRatio, barHeight);

        // имя (кратко, над бактерией)
        ctx.textAlign = "center";
        ctx.fillStyle = "#ffffff";
        ctx.font = "10px system-ui";
        ctx.fillText(b.name, p.x, barY - 3);

        // подробные таблички, если режим включён (снизу бактерии)
        if (showDetails) {
          const startY = p.y + radius + 25;
          const lineH = 11;

          ctx.textAlign = "center";
          ctx.font = "9px system-ui";
          ctx.fillStyle = "#e6edf3";
          ctx.fillText(`Клан: ${b.familyName || "нет"}`, p.x, startY);
          ctx.fillText(`Возраст: ${b.ageYears.toFixed(2)} лет`, p.x, startY + lineH);
          ctx.fillText(`Поколение: ${Math.floor(b.generation)}`, p.x, startY + lineH * 2);
          ctx.fillText(`Размер: ${Math.round(b.sizePoints)}/${b.maxSizePoints}`, p.x, startY + lineH * 3);
          ctx.fillText(`Голод: ${Math.round(b.hunger)}/${b.maxHunger}`, p.x, startY + lineH * 4);
          ctx.fillText(`Детей: ${b.childrenCount}`, p.x, startY + lineH * 5);
          if (b.isLeader) {
            ctx.fillStyle = "#ffa657";
            ctx.fillText(`Лидер колонии`, p.x, startY + lineH * 6);
          }
        }
      }
      ctx.restore();
    }

    function updateLeftHud() {
      const count = bacteria.length;
      const foodCount = food.length;

      let maxGeneration = 0;
      let maxAge = 0;
      for (const b of bacteria) {
        if (b.generation > maxGeneration) maxGeneration = b.generation;
        if (b.ageYears !== undefined && b.ageYears > maxAge) maxAge = b.ageYears;
      }

      const totalBorn = lastStats ? lastStats.totalBorn : 0;
      const totalDied = lastStats ? lastStats.totalDied : 0;

      hudRow1.innerHTML =
        `<span class="label">Бактерий:</span><span class="value">${count}</span>` +
        `<span class="label">Еда:</span><span class="value">${foodCount}</span>` +
        `<span class="label">Мир:</span><span class="value">${world.width}×${world.height}</span>`;

      hudRow2.innerHTML =
        `<span class="label">Родилось:</span><span class="value">${totalBorn}</span>` +
        `<span class="label">Умерло:</span><span class="value">${totalDied}</span>`;

      hudRow3.innerHTML =
        `<span class="label">Макс. поколение:</span><span class="value">${Math.floor(maxGeneration)}</span>` +
        `<span class="label">Макс. возраст:</span><span class="value">${maxAge.toFixed(1)} лет</span>`;
    }

    function updateRightHud() {
      // собираем статистику по колониям
      const colonies = new Map();
      for (const b of bacteria) {
        const id = b.familyId || 0;
        if (!colonies.has(id)) {
          colonies.set(id, {
            familyId: id,
            familyName: b.familyName || "нет",
            color: b.familyColor || "#58a6ff",
            size: 0,
            leader: null
          });
        }
        const col = colonies.get(id);
        col.size += 1;
        if (!col.leader || (b.ageYears || 0) > (col.leader.ageYears || 0)) {
          col.leader = b;
        }
      }

      const list = Array.from(colonies.values()).filter(c => c.leader);
      // сортировка: по размеру клана, потом по возрасту лидера
      list.sort((a, b) => {
        if (b.size !== a.size) return b.size - a.size;
        return (b.leader.ageYears || 0) - (a.leader.ageYears || 0);
      });

      let html = "";
      list.forEach((c, idx) => {
        const leader = c.leader;
        const age = leader.ageYears !== undefined ? leader.ageYears.toFixed(2) : "?";
        const leaderMark = leader.isLeader ? " ⭐" : "";
        html += `<div class="leader-row">
          <div class="leader-main">
            <span class="leader-name">${idx + 1}. ${leader.name}${leaderMark}</span>
            <span class="leader-clan">${c.familyName}</span>
          </div>
          <div class="leader-info">
            Возраст лидера: ${age} лет · В клане: ${c.size}
          </div>
        </div>`;
      });

      leadersListEl.innerHTML = html || "<div class='leader-info'>Пока нет колоний</div>";
    }

    async function fetchState() {
      try {
        const res = await fetch(SERVER_URL + "/state", { cache: "no-cache" });
        const data = await res.json();
        world = data.world;
        worldWidth = world.width;
        worldHeight = world.height;
        bacteria = data.bacteria || [];
        food = data.food || [];
        lastStats = data.stats || null;

        // сервер ок
        if (!lastServerOk) {
          lastServerOk = true;
          serverDot.classList.remove("server-bad");
          serverDot.classList.add("server-ok");
        }
        serverStatusText.textContent = "Сервер: работает";

        updateLeftHud();
        updateRightHud();
      } catch (err) {
        // сервер не отвечает
        lastServerOk = false;
        serverDot.classList.remove("server-ok");
        serverDot.classList.add("server-bad");
        serverStatusText.textContent = "Сервер: нет связи";
      }
    }

    setInterval(fetchState, 200);

    function loop() {
      draw();
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
